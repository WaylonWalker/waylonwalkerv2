{"componentChunkName":"component---src-templates-blog-post-js","path":"/bash/","result":{"data":{"markdownRemark":{"id":"3f3371e3-1f9b-5ebc-bae5-4646a485c741","html":"<h1>Bash Notes</h1>\n<p>Bash is super powerful.</p>\n<h2>File System Full</h2>\n<p><strong>Show Remaining Space on Drives</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">df</span> -h</code></pre></div>\n<p><strong>show largest files in current directory</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">du</span> <span class=\"token builtin class-name\">.</span> -h --max-depth<span class=\"token operator\">=</span><span class=\"token number\">1</span></code></pre></div>\n<p><strong>Move files then symlink them</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> /mnt/mounted_drive\n<span class=\"token function\">mv</span> ~/bigdir /mnt/mounted_drive\n<span class=\"token function\">ln</span> -s /mnt/mounted_drive/bigdir ~/bigdir</code></pre></div>\n<h2>Fuzzy One Liners</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function-name function\">a</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>source activate \"<span class=\"token punctuation\">$(</span>conda info --envs <span class=\"token operator\">|</span> fzf <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> '<span class=\"token punctuation\">{</span>print $</code></pre></div>\n<p><strong>edit in vim</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function-name function\">vf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> fzf <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> -r -I % <span class=\"token variable\">$EDITOR</span> % <span class=\"token punctuation\">;</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>cat a file</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function-name function\">vf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> fzf <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> -r -I % <span class=\"token variable\">$EDITOR</span> % <span class=\"token punctuation\">;</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>bash execute</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function-name function\">bf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">bash</span> <span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span>fzf<span class=\"token variable\">)</span></span>\"</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>git add</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function-name function\">gadd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">git</span> status -s <span class=\"token operator\">|</span> fzf -m <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print <span class=\"token variable\">$2</span>}'</span> <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> <span class=\"token function\">git</span> <span class=\"token function\">add</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">git</span> status -s<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>git reset</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function-name function\">greset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">git</span> status -s <span class=\"token operator\">|</span>  fzf -m <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print <span class=\"token variable\">$2</span>}'</span> <span class=\"token operator\">|</span><span class=\"token function\">xargs</span> <span class=\"token function\">git</span> reset <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">git</span> status -s<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Kill a process</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function-name function\">fkill</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>kill <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ps</span> aux <span class=\"token operator\">|</span> fzf <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print(<span class=\"token variable\">$2</span>)}'</span><span class=\"token variable\">)</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Finding things</h2>\n<h3>Files</h3>\n<p><a href=\"https://github.com/sharkdp/fd\">fd-find</a> is amazing for finding files, it even respects your <code class=\"language-text\">.gitignore</code> file 😲.  Install with <code class=\"language-text\">apt install fd-find</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">fd md</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ag -g python</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">find</span> <span class=\"token builtin class-name\">.</span> -n <span class=\"token string\">\"*.md\"</span></code></pre></div>\n<p><em>++Vanilla Bonus</em></p>\n<h3>Content</h3>\n<p>** show matching text **</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ag python</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">grep</span> -iR Python</code></pre></div>\n<p><em>++Vanilla Bonus</em></p>\n<p>** show file names only **</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ag -l python</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">grep</span> -iRl python</code></pre></div>\n<p><em>++Vanilla Bonus</em></p>\n<h3>Recursively Replace text</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function-name function\">agr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>ag -l <span class=\"token string\">\"<span class=\"token variable\">$1</span>\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> <span class=\"token function\">sed</span> -i <span class=\"token string\">\"s/<span class=\"token variable\">$1</span>/<span class=\"token variable\">$2</span>/g\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p><em>++Vanilla Bonus</em></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function-name function\">grepr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>grep -iRl <span class=\"token string\">\"<span class=\"token variable\">$1</span>\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> <span class=\"token function\">sed</span> -i <span class=\"token string\">\"s/<span class=\"token variable\">$1</span>/<span class=\"token variable\">$2</span>/g\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Extending</strong> <code class=\"language-text\">**agr**</code> <strong>or</strong> <code class=\"language-text\">**grepr**</code></p>\n<p>There are so many options inside of <code class=\"language-text\">grep</code>, <code class=\"language-text\">ag</code>, and <code class=\"language-text\">sed</code> that you could many an enormous amount of these if you really wanted to, but I like to keep it simple.  These cover 90% of my usage.  If I wanted to change something in the second half I would just paste in this command and edit it. More often though I want to limit the input, say only replace word1 to word2 inside of markdown files.</p>\n<p><strong>Limited Scope</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">fd md <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> argr python python3</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">find</span> <span class=\"token builtin class-name\">.</span> -n <span class=\"token string\">\"*.md\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> grepr python python3</code></pre></div>\n<p><em>++Vanilla Bonus</em></p>\n<a class=\"onelinelink\" href=\"https://waylonwalker.com/refactor-in-cli/\">\n<img style=\"float: right;\" align=\"right\" src=\"https://waylonwalker.com/static/caee54c45632d974fe802bdbb34f8b54/630fb/refactor-in-cli-xmas2020.png\" alt=\"article cover for Large Refactor At The Command Line\">\n<div class=\"right\">\n    <h2>Large Refactor At The Command Line</h2>\n    <p class=\"description\">\n    As projects grow patterns that worked early on break and we need to change things to make the project easier to work wit\n    </p>\n    <p class=\"url\">\n    <span class=\"read-more\">read more</span>  waylonwalker.com\n    </p>\n</div>\n</a>\n<blockquote>\n<p>I use these replace commands heavily when doing large refactorings.</p>\n</blockquote>\n<h3>conditionally configure</h3>\n<p>I like this one when there is not a good cli into config files and I need to replace something like a true to false if the value is in the config and append to the config if its not.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function-name function\">grepr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\"># replaces first string with second string inside file from third argument</span>\n    <span class=\"token comment\"># example:</span>\n    <span class=\"token comment\">#   grepr \"allow_conda_downgrades:.*\" \"allow_conda_downgrades: true\" ~/.condarc</span>\n    <span class=\"token keyword\">if</span> <span class=\"token function\">grep</span> -xq <span class=\"token variable\">$1</span> <span class=\"token variable\">$3</span>\n    <span class=\"token keyword\">then</span>\n        <span class=\"token function\">sed</span> -i <span class=\"token string\">\"s|<span class=\"token variable\">$1</span>|<span class=\"token variable\">$2</span>|g\"</span> <span class=\"token variable\">$3</span>\n    <span class=\"token keyword\">else</span>\n        <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$2</span>\"</span> <span class=\"token operator\">>></span> <span class=\"token variable\">$3</span>\n    <span class=\"token keyword\">fi</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Watch the time</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">watch</span> -n <span class=\"token number\">1</span> <span class=\"token function\">date</span></code></pre></div>\n<p><em>++Vanilla Bonus</em></p>\n<p><strong>with figlet</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">watch</span> -n <span class=\"token number\">1</span> <span class=\"token function\">bash</span> -c <span class=\"token string\">\"date | figlet\"</span></code></pre></div>\n<h3>watch a function</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function-name function\">run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token function\">date</span>\naws s3 <span class=\"token function\">sync</span> <span class=\"token variable\">$BUCKET</span> <span class=\"token builtin class-name\">.</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token builtin class-name\">export</span> -f run\n<span class=\"token function\">watch</span> -n <span class=\"token number\">10</span> run</code></pre></div>\n<h3>if conda environment does not exist create it</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">conda info --envs <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> my_env <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"my_env environment is installed\"</span> <span class=\"token operator\">||</span> conda create -n my_env <span class=\"token assign-left variable\">python</span><span class=\"token operator\">=</span><span class=\"token number\">3.8</span> -y\n<span class=\"token builtin class-name\">source</span> activate my_env</code></pre></div>\n<h1>Rename multiple files</h1>\n<p>more info from <a href=\"https://linuxize.com/post/how-to-rename-files-in-linux/\">linuxize</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">f</span> <span class=\"token keyword\">in</span> *.png<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n   <span class=\"token function\">mv</span> <span class=\"token variable\">${f}</span> prefix-<span class=\"token variable\">${f}</span>\n<span class=\"token keyword\">done</span></code></pre></div>\n<h2>convert all files in a directory to unix</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">dos2unix **/*</code></pre></div>\n<h2>recursively remove all whitespace from .py files</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">find</span> **/*.py -type f -exec <span class=\"token function\">sed</span> -i <span class=\"token string\">'s/ *$//'</span> <span class=\"token string\">'{}'</span> <span class=\"token string\">';'</span></code></pre></div>\n<h2>recursively autopep8</h2>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">find <span class=\"token punctuation\">.</span> <span class=\"token operator\">-</span>name <span class=\"token string\">'*.py'</span> <span class=\"token operator\">-</span><span class=\"token keyword\">exec</span> autopep8 <span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token keyword\">in</span><span class=\"token operator\">-</span>place <span class=\"token string\">'{}'</span> \\<span class=\"token punctuation\">;</span></code></pre></div>\n<h2>make bash script a runnable command</h2>\n<p>include a shebang</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#! /bin/bash</span></code></pre></div>\n<p>chmod</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">chmod</span> +x /usr/local/bin/my_script</code></pre></div>\n<p>accept positional input</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#! /bin/bash</span>\n<span class=\"token assign-left variable\">input</span><span class=\"token operator\">=</span><span class=\"token variable\">$1</span>\n<span class=\"token builtin class-name\">echo</span> input</code></pre></div>\n<h1>Using pyp</h1>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">pipx <span class=\"token function\">install</span> pyp</code></pre></div>\n<h2>replacement for cut</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ python -m http.server <span class=\"token number\">5000</span> <span class=\"token operator\">&amp;</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token number\">8574</span>\n\n✦ ❯ Serving HTTP on <span class=\"token number\">0.0</span>.0.0 port <span class=\"token number\">5000</span> <span class=\"token punctuation\">(</span>http://0.0.0.0:5000/<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">..</span>.\n\n✦ ❯ <span class=\"token function\">ps</span> aux <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">\"python -m http.server\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> -v <span class=\"token function\">grep</span> <span class=\"token operator\">|</span> pyp <span class=\"token string\">'line.split()[1]'</span> <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> <span class=\"token function\">kill</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>  + terminated  python -m http.server <span class=\"token number\">5000</span></code></pre></div>\n<h2>replacement for wc</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">conda info --envs <span class=\"token operator\">|</span> pyp <span class=\"token string\">'len(lines) - 3 # account for header and base'</span></code></pre></div>\n<h2>print contents of shell function</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">declare</span> -f <span class=\"token operator\">&lt;</span>function-name<span class=\"token operator\">></span></code></pre></div>\n<h2>batch rename files</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">f</span> <span class=\"token keyword\">in</span> *.jpeg<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n    <span class=\"token function\">mv</span> -- <span class=\"token string\">\"<span class=\"token variable\">$f</span>\"</span> <span class=\"token string\">\"<span class=\"token variable\">${f<span class=\"token operator\">%</span>.jpeg}</span>.jpg\"</span>\n<span class=\"token keyword\">done</span></code></pre></div>\n<h2>convert markdown files to reveal.js</h2>\n<p><a href=\"https://github.com/jgm/pandoc/wiki/Using-pandoc-to-produce-reveal.js-slides\">https://github.com/jgm/pandoc/wiki/Using-pandoc-to-produce-reveal.js-slides</a>\ninstall pandoc</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">apt</span> <span class=\"token function\">install</span> pandoc</code></pre></div>\n<p>setup</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://github.com/hakimel/reveal.js/archive/master.tar.gz\n<span class=\"token function\">tar</span> -xzvf master.tar.gz\n<span class=\"token function\">mv</span> reveal.js-master reveal.js</code></pre></div>\n<p>convert</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">pandoc -t revealjs -s -o myslides.html myslides.md -V revealjs-url<span class=\"token operator\">=</span>https://unpkg.com/reveal.js@3.9.2/</code></pre></div>\n<h2>Render Markdown at the command line</h2>\n<p><a href=\"https://github.com/charmbracelet/glow\">Glow</a> is a terminal markdown renderer written in go.  There iis a prebuilt binary that can simply be unzipped and executed to render markdow.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://github.com/charmbracelet/glow/releases/download/v0.2.0/glow_0.2.0_linux_x86_64.tar.gz\n<span class=\"token function\">tar</span> -xzf glow_0.2.0_linux_x86_64.tar.gz\n<span class=\"token function\">chmod</span> +x glow\n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> glow /usr/bin\n\nglow <span class=\"token operator\">&lt;</span>filename<span class=\"token operator\">></span></code></pre></div>\n<h2>Autocomplete for click applications</h2>\n<p>see the <a href=\"https://click.palletsprojects.com/en/7.x/bashcomplete/\">docs</a> for more details</p>\n<h2>Autocomplete for non click python cli's</h2>\n<p>shtab <a href=\"https://github.com/iterative/shtab\" title=\"https://github.com/iterative/shtab\">https://github.com/iterative/shtab</a></p>\n<h2>Ensure functions reset context</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function-name function\">project_log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token assign-left variable\">_dir</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">pwd</span><span class=\"token variable\">)</span></span>\n   <span class=\"token function-name function\">_project_log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin class-name\">cd</span> ~/projects/project\n      <span class=\"token function\">git</span> log\n   <span class=\"token punctuation\">}</span>\n   _project_log <span class=\"token variable\">$@</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\">$_dir</span> <span class=\"token operator\">||</span> <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\">$_dir</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","fields":{"slug":"/bash/"},"frontmatter":{"date":"2019-09-08T05:00:00.000Z","title":"Bash","description":"Waylon Walker's Bash Notes","status":"published","cover":{"absolutePath":"/home/runner/work/waylonwalkerv2/waylonwalkerv2/static/hannah-gibbs-BINLgyrG_fI-unsplash.jpg","xsm_img":{"fixed":{"src":"/static/c4381601d570bb796e3fceb606b40e06/2c7f8/hannah-gibbs-BINLgyrG_fI-unsplash.jpg","srcWebp":"/static/c4381601d570bb796e3fceb606b40e06/f6b6d/hannah-gibbs-BINLgyrG_fI-unsplash.webp"}},"sm_img":{"fixed":{"src":"/static/c4381601d570bb796e3fceb606b40e06/9dc27/hannah-gibbs-BINLgyrG_fI-unsplash.jpg","srcWebp":"/static/c4381601d570bb796e3fceb606b40e06/403a4/hannah-gibbs-BINLgyrG_fI-unsplash.webp"}},"med_img":{"fixed":{"src":"/static/c4381601d570bb796e3fceb606b40e06/0f3a1/hannah-gibbs-BINLgyrG_fI-unsplash.jpg","srcWebp":"/static/c4381601d570bb796e3fceb606b40e06/e9589/hannah-gibbs-BINLgyrG_fI-unsplash.webp"}},"full":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAcmAVA//xAAXEAADAQAAAAAAAAAAAAAAAAAAAQIR/9oACAEBAAEFApUjzT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAZEAABBQAAAAAAAAAAAAAAAAABABARISL/2gAIAQEABj8C0YCpv//EABgQAAMBAQAAAAAAAAAAAAAAAAABEVEh/9oACAEBAAE/IXON2lFtVWsh/9oADAMBAAIAAwAAABAAD//EABYRAQEBAAAAAAAAAAAAAAAAABEQIf/aAAgBAwEBPxBwn//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAECAQE/EIf/xAAaEAACAwEBAAAAAAAAAAAAAAAAAREhQWGB/9oACAEBAAE/ELiC2mPBWaxRDfg4PD//2Q==","width":1000,"height":420,"src":"/static/c4381601d570bb796e3fceb606b40e06/9cf42/hannah-gibbs-BINLgyrG_fI-unsplash.jpg","srcSet":"/static/c4381601d570bb796e3fceb606b40e06/9cf42/hannah-gibbs-BINLgyrG_fI-unsplash.jpg 1x"},"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAcmAVA//xAAXEAADAQAAAAAAAAAAAAAAAAAAAQIR/9oACAEBAAEFApUjzT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAZEAABBQAAAAAAAAAAAAAAAAABABARISL/2gAIAQEABj8C0YCpv//EABgQAAMBAQAAAAAAAAAAAAAAAAABEVEh/9oACAEBAAE/IXON2lFtVWsh/9oADAMBAAIAAwAAABAAD//EABYRAQEBAAAAAAAAAAAAAAAAABEQIf/aAAgBAwEBPxBwn//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAECAQE/EIf/xAAaEAACAwEBAAAAAAAAAAAAAAAAAREhQWGB/9oACAEBAAE/ELiC2mPBWaxRDfg4PD//2Q==","aspectRatio":2.380952380952381,"src":"/static/c4381601d570bb796e3fceb606b40e06/9cf42/hannah-gibbs-BINLgyrG_fI-unsplash.jpg","srcSet":"/static/c4381601d570bb796e3fceb606b40e06/ff9d4/hannah-gibbs-BINLgyrG_fI-unsplash.jpg 250w,\n/static/c4381601d570bb796e3fceb606b40e06/2dc04/hannah-gibbs-BINLgyrG_fI-unsplash.jpg 500w,\n/static/c4381601d570bb796e3fceb606b40e06/9cf42/hannah-gibbs-BINLgyrG_fI-unsplash.jpg 1000w,\n/static/c4381601d570bb796e3fceb606b40e06/48be0/hannah-gibbs-BINLgyrG_fI-unsplash.jpg 1200w","sizes":"(max-width: 1000px) 100vw, 1000px"}}}}}},"pageContext":{"id":"3f3371e3-1f9b-5ebc-bae5-4646a485c741","prev":{"id":"2323e978-45ff-5c4a-be68-3d9c65343212","html":"<h1>background tasks in python</h1>\n<p>I have tried most of the different methods in the past and found that copying and pasting the <a href=\"https://docs.python.org/3/library/concurrent.futures.html#threadpoolexecutor-example\">threadpoolexecutor example</a> or the <a href=\"https://docs.python.org/3/library/concurrent.futures.html#processpoolexecutor-example\">processpoolexecutor example</a> from the standard library documentation to be the most reliable.  Since this is often something that I stuff in the back of a utility module of a library it is not something that I write often enough to be familiar with, which makes it both hard to write and hard to read and debug.  If you are looking for a good overview of the difference concurrency <a href=\"https://twitter.com/raymondh\">Raymond Hettinger</a> has a great talk about the difference between the various different methods, when to use them and why.</p>\n<p>Recently a new python library was released to make running tasks in the background very simple. The <a href=\"https://github.com/kennethreitz/background\">background</a> project by Kenneth Reitz is a high level implementation of python 3's ThreadPoolExecutor.  I have been playing around with this project over the last week and I will say that this is definitely the simplest way to run background tasks in python by far.  It really simplifes the syntax and lets me focus on my job rather than implementing custom concurrent code that is more difficult to debug.</p>\n<h2>Background</h2>\n<p>I have pulled the latest version of the project in Sept 2017.  I found that it had some updates that were important to pass *args and **kwargs compared to the pypi version.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> time\n<span class=\"token keyword\">import</span> background <span class=\"token keyword\">as</span> bg\n\n<span class=\"token operator\">%</span>load_ext watermark\n<span class=\"token operator\">%</span>watermark <span class=\"token operator\">-</span>d <span class=\"token operator\">-</span>v <span class=\"token operator\">-</span>p background</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">2017-09-16\n\nCPython 3.6.2\nIPython 6.1.0\n\nbackground n\u0007</code></pre></div>\n<h2>Define Worker Functions</h2>\n<p>Each of these worker functions takes 1s to run, simulating a moderately long calculation that we need to do many times over.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">work</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">1</span>\n\n<span class=\"token decorator annotation punctuation\">@bg<span class=\"token punctuation\">.</span>task</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">bg_work</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">1</span></code></pre></div>\n<h2>Run the Worker Functions</h2>\n<h2>Blocking function</h2>\n<p>This function is blocking each time the function runs, thus taking 1 second to run for each calculation.  The example below took exactly <strong>100 s</strong> to run 100 calculations.  Depending on your use case this may not be fast enough.  If the calculations do not rely on the global state</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">%</span><span class=\"token operator\">%</span>time\n<span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    work<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Wall time: 1min 40s</code></pre></div>\n<h3>Reaction</h3>\n<p>I  know what half of you are saying to yourselfs..</p>\n<blockquote>\n<p>   !!What!! that took 100 s, by now my users have already sent a dozen messages and filed an issue that my feature is down</p>\n</blockquote>\n<p>and the other half</p>\n<blockquote>\n<p>Seriously that wasnt even enough time to grab a coffee.  Any real time consuming analysis takes at least 3 dats 14 hours 159 seconds before I start to care about concurrency</p>\n</blockquote>\n<p>To you I say... I am impatient and I got other things to do rather than wait on this maching to finish its work.  Let's get into this concurrency stuff.</p>\n<h2>Background Function</h2>\n<p>This function spins off worker processes and runs much faster.  By default background sets the number of processes to the number of cpu cores available, Therefore this function should run in n/4 + (inefficiency).  Here we see that the result is just over <strong>13 s</strong>.</p>\n<p>Note:<em>Since there is a bit of inefficiency added by needing to handle all of the threads it is not exactly divided by the number of workers.</em></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">%</span><span class=\"token operator\">%</span>time\nf_list <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>bg_work<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>f<span class=\"token punctuation\">.</span>done<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> f <span class=\"token keyword\">in</span> f_list<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">pass</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Wall time: 13.1 s</code></pre></div>\n<h3>Reaction</h3>\n<p>I know what your saying this time.</p>\n<blockquote>\n<p>really a 7.6x improvement...  Is that really even woth the extra work.</p>\n</blockquote>\n<p>Fine then lets crank it up to 11!</p>\n<h3>Lots of Background</h3>\n<p>lets set the number of background processes to a value just higher to than the number of workers we need to run in order to start them all simultaneously. With this simple example that is not very CPU intensive we see the result is just over the amount of time that it takes to run 1 worker.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">bg<span class=\"token punctuation\">.</span>n <span class=\"token operator\">=</span> <span class=\"token number\">110</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">%</span><span class=\"token operator\">%</span>time\nf_list <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>bg_work<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>f<span class=\"token punctuation\">.</span>done<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> f <span class=\"token keyword\">in</span> f_list<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">pass</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Wall time: 1.09 s</code></pre></div>\n<h3>Reaction</h3>\n<blockquote>\n<p>91x improvement by putting my calculations into a function, adding a decorator, and some checks, im in.</p>\n</blockquote>\n<h2>On Tap</h2>\n<p>This week while taking it up to 11 I was enjoying a super thick and rich cup of El Salvador Finca Rosa from Onyx Coffee Labs.  Check out their love for letting the bean speak for it self and producing a great cup.</p>\n<p><a href=\"https://onyxcoffeelab.com\"><img src=\"https://cdn.shopify.com/s/files/1/1707/3261/files/coffee_science.png?5305428688827820856\"></a></p>","fields":{"slug":"/background-1/"},"frontmatter":{"tags":["python","data"],"title":"background tasks in python","description":"none","templateKey":"blog-post","status":"draft","date":"2017-09-16T00:00:00.000Z","cover":{"med_img":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQDBf/EABYBAQEBAAAAAAAAAAAAAAAAAAACA//aAAwDAQACEAMQAAABldOWNo2g/8QAGhAAAgIDAAAAAAAAAAAAAAAAARIAAgMhIv/aAAgBAQABBQIKYphpAqC2sp6//8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8BJ//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABoQAAICAwAAAAAAAAAAAAAAAAEQADEyUXH/2gAIAQEABj8CG+SlgH//xAAaEAADAQEBAQAAAAAAAAAAAAAAAREhQVFh/9oACAEBAAE/IZ2TcKCNapGnDREYeThi+o//2gAMAwEAAgADAAAAEFDv/8QAFhEAAwAAAAAAAAAAAAAAAAAAARAh/9oACAEDAQE/EKC//8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQIBAT8QZ//EABwQAQEAAgMBAQAAAAAAAAAAAAERACExUWGBkf/aAAgBAQABPxASBlVJ3xmuBbXzLNUX24bUrRDzIbFp5/MQYDS8b+95/9k=","width":500,"height":335,"src":"/static/7d7fa9d9a34c2456883afe754bba831d/0f3a1/gabriele-diwald-199200-unsplash.jpg","srcSet":"/static/7d7fa9d9a34c2456883afe754bba831d/0f3a1/gabriele-diwald-199200-unsplash.jpg 1x,\n/static/7d7fa9d9a34c2456883afe754bba831d/f9913/gabriele-diwald-199200-unsplash.jpg 1.5x,\n/static/7d7fa9d9a34c2456883afe754bba831d/a7715/gabriele-diwald-199200-unsplash.jpg 2x"}},"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIEA//EABYBAQEBAAAAAAAAAAAAAAAAAAACA//aAAwDAQACEAMQAAABFpkjbMQP/8QAHBAAAQMFAAAAAAAAAAAAAAAAAQIDMQAREiIy/9oACAEBAAEFAksuWwBpWpHAh2f/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPwEn/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGRAAAQUAAAAAAAAAAAAAAAAAAAECICFx/9oACAEBAAY/ArdFMP/EAB0QAQACAQUBAAAAAAAAAAAAAAEAESExUXGhscH/2gAIAQEAAT8hBcUM1A7vCU4mpwzw+zrJ/9oADAMBAAIAAwAAABCo7//EABcRAQADAAAAAAAAAAAAAAAAAAABETH/2gAIAQMBAT8QzK3/xAAWEQADAAAAAAAAAAAAAAAAAAABEDH/2gAIAQIBAT8QNX//xAAeEAACAQQDAQAAAAAAAAAAAAAAAREhMUHwUWFx0f/aAAgBAQABPxCF+nUXwbUJMpWK+EM4zZm+4LRa7s//2Q==","width":200,"height":85,"src":"/static/7d7fa9d9a34c2456883afe754bba831d/a6613/gabriele-diwald-199200-unsplash.jpg","srcSet":"/static/7d7fa9d9a34c2456883afe754bba831d/a6613/gabriele-diwald-199200-unsplash.jpg 1x,\n/static/7d7fa9d9a34c2456883afe754bba831d/b97e6/gabriele-diwald-199200-unsplash.jpg 1.5x,\n/static/7d7fa9d9a34c2456883afe754bba831d/eeb4b/gabriele-diwald-199200-unsplash.jpg 2x"}}}}},"next":{"id":"3e3a6337-1bca-5c36-be9e-6902e8e4cb75","html":"<p>This past week I had a really weird bug in my <a href=\"https://kedro.readthedocs.io/\">kedro</a> pipeline.  For some reason data running through my pipeline was coming out completely made no sense, but if I manually request raw data outside of the pipeline it matched expectations.</p>\n<p><strong>NOTE</strong> While this story is about a kedro pipeline, it can be applied anywhere closures are put into an iterable.</p>\n<h2><img src=\"https://waylonwalker.com/bind-dynamic-lambdas-1.png\" alt=\"Debugger to the rescue\"></h2>\n<p>After a few days of looking at it off and on, I pinpointed that it was all the way down in the raw layer. Right as data is coming off of the database.  For this I already had existing <code class=\"language-text\">sql</code> files stored and a <code class=\"language-text\">read_sql</code> function to get the data so I opted to just set up the pipeline to utilize the existing code as much as possible, leaning on the <a href=\"https://kedro.readthedocs.io/\">kedro</a> framework a bit less.</p>\n<p>I have dynamically created lists of pipeline nodes many times in the past, but typically I take data from <a href=\"https://kedro.readthedocs.io/\">kedro</a> input and use it in the lambda.  I prefer the simplicity of using lambdas over <code class=\"language-text\">functools.partial</code>.  It typically looks something like this.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 👍  I do this all the time</span>\n<span class=\"token keyword\">from</span> kedro<span class=\"token punctuation\">.</span>pipeline <span class=\"token keyword\">import</span> node\n<span class=\"token keyword\">from</span> my_generic_project_lib <span class=\"token keyword\">import</span> clean\n\ndatasets_to_clean <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'sales'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'inventory'</span><span class=\"token punctuation\">]</span>\nnodes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">for</span> dataset <span class=\"token keyword\">in</span> datasets_to_clean<span class=\"token punctuation\">:</span>\n   nodes<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>\n      node<span class=\"token punctuation\">(</span>\n         func<span class=\"token operator\">=</span><span class=\"token keyword\">lambda</span> x<span class=\"token punctuation\">:</span> clean<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n         inputs <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f'raw_</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>dataset<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span>\n         outputs<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f'int_</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>dataset<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span>\n         tags<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'int'</span><span class=\"token punctuation\">,</span> dataset<span class=\"token punctuation\">]</span>\n         name<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f'create_int_</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>dataset<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span>\n      <span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">)</span></code></pre></div>\n<p>What was different this time is that I needed to pass in the name of the dataset to my read_sql function, not the data loaded in the framework.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># ❌ This does not work</span>\n<span class=\"token keyword\">from</span> kedro<span class=\"token punctuation\">.</span>pipeline <span class=\"token keyword\">import</span> node\n<span class=\"token keyword\">from</span> my_generic_project_lib <span class=\"token keyword\">import</span> read_sql\n\ndatasets_to_read <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'sales'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'inventory'</span><span class=\"token punctuation\">]</span>\nnodes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">for</span> dataset <span class=\"token keyword\">in</span> datasets_to_clean<span class=\"token punctuation\">:</span>\n   nodes<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>\n      node<span class=\"token punctuation\">(</span>\n         func<span class=\"token operator\">=</span><span class=\"token keyword\">lambda</span><span class=\"token punctuation\">:</span> read_sql<span class=\"token punctuation\">(</span>dataset<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 💥 The major issue</span>\n         inputs <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f'dummy'</span></span>\n         outputs<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f'int_</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>dataset<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span>\n         tags<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'int'</span><span class=\"token punctuation\">,</span> dataset<span class=\"token punctuation\">]</span>\n         name<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f'create_int_</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>dataset<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span>\n      <span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">)</span></code></pre></div>\n<h2><img src=\"https://waylonwalker.com/bind-dynamic-lambdas-2.png\" alt=\"Seriously\"></h2>\n<p>As I am still oblivious to what has happened I pop in a <code class=\"language-text\">breakpoint()</code> and quickly see that during the first run the dataset passed into <code class=\"language-text\">read_sql</code> was <code class=\"language-text\">&#39;inventory&#39;</code>, in fact, every single one was <code class=\"language-text\">&#39;inventory&#39;</code>.  The lambda is just using the latest value of dataset from outside and has no <code class=\"language-text\">local</code> <code class=\"language-text\">dataset</code> attached to it.</p>\n<h2><img src=\"https://waylonwalker.com/bind-dynamic-lambdas-3.png\" alt=\"The simple fix \"></h2>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 👍 Much Better</span>\n<span class=\"token keyword\">from</span> kedro<span class=\"token punctuation\">.</span>pipeline <span class=\"token keyword\">import</span> node\n<span class=\"token keyword\">from</span> my_generic_project_lib <span class=\"token keyword\">import</span> read_sql\n\ndatasets_to_read <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'sales'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'inventory'</span><span class=\"token punctuation\">]</span>\nnodes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">for</span> dataset <span class=\"token keyword\">in</span> datasets_to_clean<span class=\"token punctuation\">:</span>\n   nodes<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>\n      node<span class=\"token punctuation\">(</span>\n         func<span class=\"token operator\">=</span><span class=\"token keyword\">lambda</span> dataset<span class=\"token operator\">=</span>dataset<span class=\"token punctuation\">:</span> read_sql<span class=\"token punctuation\">(</span>dataset<span class=\"token punctuation\">)</span> <span class=\"token comment\"># dataset is now bound to the lambda ✨</span>\n         inputs <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f'dummy'</span></span>\n         outputs<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f'int_</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>dataset<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span>\n         tags<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'int'</span><span class=\"token punctuation\">,</span> dataset<span class=\"token punctuation\">]</span>\n         name<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f'create_int_</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>dataset<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span>\n      <span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">)</span></code></pre></div>\n<h2><img src=\"https://waylonwalker.com/bind-dynamic-lambdas-4.png\" alt=\"Try it yourself\"></h2>\n<p>I made a slightly more simple example so that you can try it and play with it yourself, edit it, share it with your friends, laugh at my mistake, whatever you like.</p>\n<iframe height=\"400px\" width=\"100%\" src=\"https://repl.it/@WaylonWalker/BindDynamicLambdas?lite=true\" scrolling=\"no\" frameborder=\"no\" allowtransparency=\"true\" allowfullscreen=\"true\" sandbox=\"allow-forms allow-pointer-lock allow-popups allow-same-origin allow-scripts allow-modals\"></iframe>","fields":{"slug":"/bind-dynamic-lambdas/"},"frontmatter":{"tags":[],"title":"TIL: Bind arguments to dynamically generated lambdas in python","description":"This past week I had a really weird bug in my [kedro](https://kedro.readthedocs.io/) pipeline.  For some reason data running through my pipeline was coming out completely made no sense, but if I manually request raw data outside of the pipeline it matched expectations.","templateKey":"blog-post","status":"published","date":"2020-04-27T12:13:00.000Z","cover":{"med_img":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABz0lEQVQY02OQUjYQU9YVVdKTkNcVU9AWk9MWltWSUNCVVjNU0DSVVzOSUzOSVTWUVdGXUdGTUjWQUdaTBpIqBlLK+gymOk4uBj5GWg765i4mdp7WrgE2rgEWjn6WDr4y6iZAJKdhqqRtIqtuLKFkIKkMRIYSyobiSvpAxKCqbumg526r725l7e3nH+vjG+3gGmTt7Gdm5yWjZiKmoAd0iKCMpqSyvpSKgaSKIdCl4nKaUkq6QBEGCSV9XkVdYXUjaTl9fQPH3NxKawdf94CoxPSC8Lh0A0uXjLwya2dfBU0TkG1ymjK6tjqBhWIa9sIyOgyiygbmyvrWKvqCiroKWmZ7Dhw+furs5m27t+3Yc+zkmQlTZ1+5dnvzjgMlNR18Ehryhk7a0e3KiQtLqmLsbXUY+OV1KhLSS6ISBeR1pVUMDK3cbFwC9C1ctE0dfELifEPjfAP9U5ICwyN8NbTUxc0icjpbDq31f7jbKdDHkAHoB2ElEJJU0gd6AeRDaU0ROR0hGS0JZQMTG1cLS21PV21nRx0ra0N2MYO8dJtX+63iw4yEZMF+llLSh+gEsYFBAkPAsBVT0BVTNBSRNxSWNxCRBymQVNLTMTQEMsQV9QG6q25ETAqbYgAAAABJRU5ErkJggg==","width":500,"height":210,"src":"/static/3f3ad034cc54528cdb99230877c2153b/46604/bind-dynamic-lambdas-xmas2020.png","srcSet":"/static/3f3ad034cc54528cdb99230877c2153b/46604/bind-dynamic-lambdas-xmas2020.png 1x,\n/static/3f3ad034cc54528cdb99230877c2153b/d8815/bind-dynamic-lambdas-xmas2020.png 1.5x,\n/static/3f3ad034cc54528cdb99230877c2153b/31987/bind-dynamic-lambdas-xmas2020.png 2x"}},"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAACAklEQVQozzWSS2sTURTHZ6loidU85nUzk7nzfuTemck4TWOalEyTxjSNVRi1oPahSV0kUmmjG3cVF25cFRGhgjtRcVEUBEXcuCv4xg/g59AbMfDncg7c/znn/u6hgIwYFQOIgYKA7LIQ8RDnVFewgpzqi7onqh6vYkHGgopYzRUgAtoo5RRMpSQ7CZ20YKey5gnePM4b5EwLDtALol4AqgcUYvZ4GZO6DESchNhxTDW9M0UzQsUonF0oN5aqzXOl2mKtFSv5EiO7vOoDzc9qHqe4tISJGIhp6GYkROcQFeFWBTWnZ9r1RhzH63PNmDjn2udNv/rvNkoJdkZ0WPKisTJAp0WLhZiahHnaKIiSD2GwutIvhHVvuh5WTvf6Q0EPolZMpHszaTFPumUEi4xjzK8xTpRgLUrkdIXTaMVNsNrDvadfvv/88PHTm7fvDz5/3X209+LV/rcfv5693O/2hxMZBRhTavum2H0+39uqz1rU3ZXug0trCXHELFqINwa3Ll8bNDrLqxubg607vf52r785vL198cp6is1lS8tLO0927ncP3p19fC+grKnIDGtp0SEkjnH6kbQ8QSuTvHE4mXPCKCxXo4p8oWPEi1a5jA5xxeuDzp/fp17vBl6AqSQwU1mLgCEi/jGV/wH5Ksl0CW1eGa1AEti6bd+4ejLv4aMM+gvi0n3BPREJugAAAABJRU5ErkJggg==","width":200,"height":85,"src":"/static/3f3ad034cc54528cdb99230877c2153b/71e30/bind-dynamic-lambdas-xmas2020.png","srcSet":"/static/3f3ad034cc54528cdb99230877c2153b/71e30/bind-dynamic-lambdas-xmas2020.png 1x,\n/static/3f3ad034cc54528cdb99230877c2153b/24123/bind-dynamic-lambdas-xmas2020.png 1.5x,\n/static/3f3ad034cc54528cdb99230877c2153b/492a0/bind-dynamic-lambdas-xmas2020.png 2x"}}}}},"similarPosts":[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]}},"staticQueryHashes":["2992646504"]}