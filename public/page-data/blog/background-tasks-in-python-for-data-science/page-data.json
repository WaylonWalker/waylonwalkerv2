{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/background-tasks-in-python-for-data-science/","result":{"data":{"markdownRemark":{"id":"6cd3a28e-d977-51c1-9589-59b5ab8d158a","html":"<p>This post is intended as an extension/update from <a href=\"https://waylonwalker.com/blog/background_1/\">background tasks in python</a>.  I started using <code class=\"language-text\">background</code> the week that Kenneth Reitz released it.  It takes away so much boilerplate from running background tasks that I use it in more places than I probably should. After taking a look at that post today, I wanted to put a better data science example in here to help folks get started.</p>\n<blockquote>\n<p>I use it in more places than I probably should</p>\n</blockquote>\n<p>Before we get into it, I want to make a shout out to Kenneth Reitz for making this so easy.  Kenneth is a python God for all that he has given to the community in so many ways, especially with his ideas in building stupid simple api's for very complicated things.</p>\n<h2>Installation</h2>\n<h3>install via pip</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pip install background</code></pre></div>\n<h3>install via github</h3>\n<p>I believe one of the later pr's to the project fixes the way arguments are passed in.  I generally clone the repo or copy the module directly into my project.</p>\n<p><strong>clone it</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">git clone https://github.com/ParthS007/background.git\ncd background\npython setup.py install</code></pre></div>\n<p><strong>copy the module</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl https://raw.githubusercontent.com/ParthS007/background/master/background.py &gt; background.py</code></pre></div>\n<h2>üêå The Slow Function</h2>\n<p>Imagine that this function is a big one!  This function is fairly realistic as it takes in some input and returns a DataFrame.  This is what a good half of my fuctions do in data science.  The internals of this function generally will include a sql query, load from s3 or a data catalog, an aggregation from another DataFrame.  In general it should do one simple thing.</p>\n<p><strong>Feel Free to copy this \"boilerplate\"</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> background\n<span class=\"token keyword\">from</span> time <span class=\"token keyword\">import</span> sleep\n<span class=\"token keyword\">import</span> pandas <span class=\"token keyword\">as</span> pd\n\n<span class=\"token decorator annotation punctuation\">@background<span class=\"token punctuation\">.</span>task</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">long_func</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    Simulates fetching data from a service \n    and returning a pandas DataFrame.\n    \n    \"\"\"</span>\n    sleep<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> pd<span class=\"token punctuation\">.</span>DataFrame<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">'number_squared'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>i<span class=\"token operator\">**</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>Calling the Slow Function</h2>\n<p><em>it's the future calling ü§ô</em></p>\n<p>If we were to call this function 10 times it would take 100s.  Not bad for a dumb example, but detrimental when this gets scaled upüí•.  We want to utilize all of our available resources to reduce our development time and get moving on our project.</p>\n<p>Calling <code class=\"language-text\">long_func</code> will return a future object.  This object has a number of methods that you can read about in the <a href=\"https://docs.python.org/3/library/concurrent.futures.html#future-objects\">cpython docs</a>.  The main one we are interested in is <code class=\"language-text\">result</code>.  I typically call these functions many times and put them into a list object so that I can track their progress and get their results.  If you needed to map inputs back to the result use a dictionary.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">%</span>time futures <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>long_func<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n\nCPU times<span class=\"token punctuation\">:</span> user <span class=\"token number\">319</span> ¬µs<span class=\"token punctuation\">,</span> sys<span class=\"token punctuation\">:</span> <span class=\"token number\">197</span> ¬µs<span class=\"token punctuation\">,</span> total<span class=\"token punctuation\">:</span> <span class=\"token number\">516</span> ¬µs\nWall time<span class=\"token punctuation\">:</span> <span class=\"token number\">212</span> ¬µs</code></pre></div>\n<h2>Do something with those <code class=\"language-text\">results()</code></h2>\n<p>Simply running the function completes in no time! This is because the future objects that are returned are non blocking and will run in a background task using the <code class=\"language-text\">ProcessPoolExecutor</code>.  To get the result back out we need to call the <code class=\"language-text\">result</code> method on the future object.<code class=\"language-text\">result</code> is a blocking function that will not realease until the function has completed.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">%</span><span class=\"token operator\">%</span>time \nfutures <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>long_func<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\npd<span class=\"token punctuation\">.</span>concat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>future<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> future <span class=\"token keyword\">in</span> futures<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\nCPU times<span class=\"token punctuation\">:</span> user <span class=\"token number\">5.38</span> ms<span class=\"token punctuation\">,</span> sys<span class=\"token punctuation\">:</span> <span class=\"token number\">3.53</span> ms<span class=\"token punctuation\">,</span> total<span class=\"token punctuation\">:</span> <span class=\"token number\">8.9</span> ms\nWall time<span class=\"token punctuation\">:</span> <span class=\"token number\">10</span> s</code></pre></div>\n<p>Note that this example completed in <code class=\"language-text\">10s</code>, the time it took for only one run, not all 10! üòé</p>\n<h2>n</h2>\n<p>üò´ <em>crank it up</em></p>\n<p>By default the number of parallel processes wil be equal to the number of cpu threads on your machine. To increase the number of parallel processes (<code class=\"language-text\">max_workers</code>) set increase <code class=\"language-text\">background.n</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">background<span class=\"token punctuation\">.</span>n <span class=\"token operator\">=</span> <span class=\"token number\">100</span></code></pre></div>\n<h1>Is it possible to overruse @background.task?</h1>\n<p>I use this essentially anywhere that I cannot vectorize a python operation and push the compute down into those fast üí® c extended libraries like numpy, and the operation takes more than a few minutes.  Nearly every big network request I make gets broken down into chunks and multithreaded.  Let me know... is is possible to overruse <code class=\"language-text\">@background.task</code>? Let me know your thoughts <a href=\"https://twitter.com/_WaylonWalker\">@_WaylonWalker</a>.</p>\n<h1>Repl.It</h1>\n<p>Play with the code here!  Try different values of background.n and n_runs.</p>\n<iframe height='800px' width='100%' src='https://repl.it/@WaylonWalker/TestRepl?lite=true' scrolling='no' frameborder='no' allowtransparency='true' allowfullscreen='true' sandbox='allow-forms allow-pointer-lock allow-popups allow-same-origin allow-scripts allow-modals'></iframe>","frontmatter":{"date":"2019-09-10T05:00:00.000Z","devto_url":null,"devto_id":null,"title":"Background Tasks in Python for Data Science","description":"","path":"python-data-science-background","twitter_cover":{"id":"46361e70-8405-5afc-901b-e61d4342a5fe","absolutePath":"/mnt/c/personal/ww/waylonwalkerv2/static/erwan-hesry-elayN_YscVg-unsplash.jpg","childImageSharp":{"id":"300bbf42-e2cc-55a6-8c0c-9d5ec5cc5478","fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIEA//EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAG3GdYUnF//xAAZEAADAAMAAAAAAAAAAAAAAAAAAQIREiH/2gAIAQEAAQUC2kpyxqcqhvh//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAExIP/aAAgBAQAGPwIhFj//xAAZEAEBAQADAAAAAAAAAAAAAAABABEhMVH/2gAIAQEAAT8hMuYLUF1EMuN5rW//2gAMAwEAAgADAAAAECzP/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oACAEDAQE/EJWv/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oACAECAQE/ELGP/8QAGxABAQEBAAMBAAAAAAAAAAAAAREAIVFhgcH/2gAIAQEAAT8QFyHyTdYgFIKfMtKR9zKQoTXLFOfusqM3/9k=","width":800,"height":418,"src":"/static/cc44cabd6c7bf02d5884090c3ef10a9c/5d469/erwan-hesry-elayN_YscVg-unsplash.jpg","srcSet":"/static/cc44cabd6c7bf02d5884090c3ef10a9c/5d469/erwan-hesry-elayN_YscVg-unsplash.jpg 1x,\n/static/cc44cabd6c7bf02d5884090c3ef10a9c/3d47d/erwan-hesry-elayN_YscVg-unsplash.jpg 1.5x,\n/static/cc44cabd6c7bf02d5884090c3ef10a9c/0c99a/erwan-hesry-elayN_YscVg-unsplash.jpg 2x"}}},"cover":{"id":"46361e70-8405-5afc-901b-e61d4342a5fe","absolutePath":"/mnt/c/personal/ww/waylonwalkerv2/static/erwan-hesry-elayN_YscVg-unsplash.jpg","childImageSharp":{"id":"300bbf42-e2cc-55a6-8c0c-9d5ec5cc5478","fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIEA//EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAG3GdYUnF//xAAZEAADAAMAAAAAAAAAAAAAAAAAAQIREiH/2gAIAQEAAQUC2kpyxqcqhvh//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAExIP/aAAgBAQAGPwIhFj//xAAZEAEBAQADAAAAAAAAAAAAAAABABEhMVH/2gAIAQEAAT8hMuYLUF1EMuN5rW//2gAMAwEAAgADAAAAECzP/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oACAEDAQE/EJWv/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oACAECAQE/ELGP/8QAGxABAQEBAAMBAAAAAAAAAAAAAREAIVFhgcH/2gAIAQEAAT8QFyHyTdYgFIKfMtKR9zKQoTXLFOfusqM3/9k=","width":1000,"height":420,"src":"/static/cc44cabd6c7bf02d5884090c3ef10a9c/9cf42/erwan-hesry-elayN_YscVg-unsplash.jpg","srcSet":"/static/cc44cabd6c7bf02d5884090c3ef10a9c/9cf42/erwan-hesry-elayN_YscVg-unsplash.jpg 1x,\n/static/cc44cabd6c7bf02d5884090c3ef10a9c/55395/erwan-hesry-elayN_YscVg-unsplash.jpg 1.5x,\n/static/cc44cabd6c7bf02d5884090c3ef10a9c/5858b/erwan-hesry-elayN_YscVg-unsplash.jpg 2x"},"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIEA//EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAG3GdYUnF//xAAZEAADAAMAAAAAAAAAAAAAAAAAAQIREiH/2gAIAQEAAQUC2kpyxqcqhvh//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAExIP/aAAgBAQAGPwIhFj//xAAZEAEBAQADAAAAAAAAAAAAAAABABEhMVH/2gAIAQEAAT8hMuYLUF1EMuN5rW//2gAMAwEAAgADAAAAECzP/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oACAEDAQE/EJWv/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oACAECAQE/ELGP/8QAGxABAQEBAAMBAAAAAAAAAAAAAREAIVFhgcH/2gAIAQEAAT8QFyHyTdYgFIKfMtKR9zKQoTXLFOfusqM3/9k=","aspectRatio":2.380952380952381,"src":"/static/cc44cabd6c7bf02d5884090c3ef10a9c/9cf42/erwan-hesry-elayN_YscVg-unsplash.jpg","srcSet":"/static/cc44cabd6c7bf02d5884090c3ef10a9c/ff9d4/erwan-hesry-elayN_YscVg-unsplash.jpg 250w,\n/static/cc44cabd6c7bf02d5884090c3ef10a9c/2dc04/erwan-hesry-elayN_YscVg-unsplash.jpg 500w,\n/static/cc44cabd6c7bf02d5884090c3ef10a9c/9cf42/erwan-hesry-elayN_YscVg-unsplash.jpg 1000w,\n/static/cc44cabd6c7bf02d5884090c3ef10a9c/55395/erwan-hesry-elayN_YscVg-unsplash.jpg 1500w,\n/static/cc44cabd6c7bf02d5884090c3ef10a9c/5858b/erwan-hesry-elayN_YscVg-unsplash.jpg 2000w,\n/static/cc44cabd6c7bf02d5884090c3ef10a9c/aebc7/erwan-hesry-elayN_YscVg-unsplash.jpg 5985w","sizes":"(max-width: 1000px) 100vw, 1000px"}}}}}},"pageContext":{"id":"6cd3a28e-d977-51c1-9589-59b5ab8d158a"}}}